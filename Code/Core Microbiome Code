## Set working directory
setwd("C:/Users/ys_cl/OneDrive - UBC/UBC W25/MICB 475/Project 2/coremicrobiome")

## Load packages
library(phyloseq)
library(microbiome)
library(tidyverse)
library(ggVennDiagram)

## Load phyloseq object
# Do respective one for female vs male phyloseq
load("../phyloseq/deer_female_phyloseq.RData")
# OR 
load("../phyloseq/deer_male_phyloseq.RData")

## Convert phyloseq object to relative abundance 
# Do respective one for female vs male phyloseq
phyloseq_female_RA <- transform_sample_counts(deer_female_phyloseq, fun=function(x) x/sum(x))
# OR
phyloseq_male_RA <- transform_sample_counts(deer_male_phyloseq, fun=function(x) x/sum(x))

## Create phyloseq objects that contain only samples that belong to each pathology group

# Females: 
female_neg <- subset_samples(phyloseq_female_RA, pathology=="Neg")
female_ln_pos <- subset_samples(phyloseq_female_RA, pathology=="LN POS")
female_br_ln_pos <- subset_samples(phyloseq_female_RA, pathology=="BR & LN POS")

# OR 

# Males: 
male_neg <- subset_samples(phyloseq_male_RA, pathology=="Neg")
male_ln_pos <- subset_samples(phyloseq_male_RA, pathology=="LN POS")
male_br_ln_pos <- subset_samples(phyloseq_male_RA, pathology=="BR & LN POS")

## Identify core members in each group
# Set choice of detection (abundance) = 0
# Set detection threshold (prevalance) = 0.2. 0.3, 0.2
female_neg_ASVs <- core_members(female_neg, detection = 0, prevalence = 0.2)
female_ln_pos_ASVs <- core_members(female_ln_pos, detection = 0, prevalence = 0.3)
female_br_ln_pos_ASVs <- core_members(female_br_ln_pos, detection = 0, prevalence = 0.2)

# OR
male_neg_ASVs <- core_members(male_neg, detection = 0, prevalence = 0.2)
male_ln_pos_ASVs <- core_members(male_ln_pos, detection = 0, prevalence = 0.3)
male_br_ln_pos_ASVs <- core_members(male_br_ln_pos, detection = 0, prevalence = 0.2)

pathology_list_full <- list(Negative = female_neg_ASVs, LN_POS = female_ln_pos_ASVs, BR_LN_POS = female_br_ln_pos_ASVs)
# OR
pathology_list_full <- list(Negative = male_neg_ASVs, LN_POS = male_ln_pos_ASVs, BR_LN_POS = male_br_ln_pos_ASVs)

## Create Venn diagram to visualize siimilarities between core members in each group
first_female_venn <- ggVennDiagram(x = pathology_list_full) +
  scale_fill_gradient(low = "white", high = "steelblue") +  # color of overlap areas
  theme(
    panel.background = element_rect(fill = "white", color = NA),  # main panel white
    plot.background = element_rect(fill = "white", color = NA),   # entire plot background white
  )

# OR
first_male_venn <- ggVennDiagram(x = pathology_list_full) +
  scale_fill_gradient(low = "white", high = "steelblue") +  # color of overlap areas
  theme(
    panel.background = element_rect(fill = "white", color = NA),  # main panel white
    plot.background = element_rect(fill = "white", color = NA),   # entire plot background white
  )

## Save the plot
ggsave(
  filename = "venn_female_pathology.png",
  plot = first_venn,
  width = 7,
  height = 6,
  dpi = 300
)

# OR

ggsave(
  filename = "venn_male_pathology.png",
  plot = first_venn,
  width = 7,
  height = 6,
  dpi = 300
)


